services:
  db:
    image: postgres
    environment:
      POSTGRES_PASSWORD: example
    ports:
      - "5432:5432"

  mq-namesrv:
    restart: always
    image: apache/rocketmq:5.3.1
    environment:
      - JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn128m
    command: sh mqnamesrv

  mq-broker:
    restart: always
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
    environment:
      - NAMESRV_ADDR=mq-namesrv:9876
      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m -Xmn256m
    command: sh mqbroker

  mq-proxy:
    restart: always
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
      - mq-broker
    ports:
      - "8081:8081"
    environment:
      - NAMESRV_ADDR=mq-namesrv:9876
      - JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn128m
    command: sh mqproxy

  create-default-orderly-data-bus:
    restart: on-failure
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
      - mq-broker
      - mq-proxy
    command:
      - sh
      - -c
      - |
        set -e
        
        # Create Default data bus
        until ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterBusOrderly -a +message.type=FIFO -o true | tee /dev/stderr | grep success; do
        echo "Retrying updateTopic for EBInterBusOrderly..."
        sleep 1
        done
        
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterDelayBusOrderly -a +message.type=DELAY | tee /dev/stderr | grep success        
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterTargetExpDecayBusOrderly -a +message.type=FIFO -o true | tee /dev/stderr | grep success
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterTargetBackoffBusOrderly -a +message.type=FIFO -o true | tee /dev/stderr | grep success 
        
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g OrderlySource -o true | tee /dev/stderr | grep success                          
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g OrderlySourceDelay | tee /dev/stderr | grep success                     
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g OrderlyTargetExpDecay -r 176 -o true | tee /dev/stderr | grep success          
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g OrderlyTargetBackoff -r 3 -o true | tee /dev/stderr | grep success
