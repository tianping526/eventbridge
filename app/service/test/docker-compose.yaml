services:
  db:
    image: postgres
    environment:
      POSTGRES_PASSWORD: example
    ports:
      - "5433:5432"
    depends_on:
      - redis

  redis:
    image: redis
    ports:
      - "6379:6379"

  mq-namesrv:
    restart: always
    image: apache/rocketmq:5.3.1
    environment:
      - JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn128m
    command: sh mqnamesrv

  mq-broker:
    restart: always
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
    environment:
      - NAMESRV_ADDR=mq-namesrv:9876
      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m -Xmn256m
    command: sh mqbroker

  mq-proxy:
    restart: always
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
      - mq-broker
    ports:
      - "8082:8082"
    environment:
      - NAMESRV_ADDR=mq-namesrv:9876
      - JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn128m
    command: sh mqproxy
    volumes:
      - ./rmq/rmq-proxy.json:/home/rocketmq/rocketmq-5.3.1/conf/rmq-proxy.json

  create-default-data-bus:
    restart: on-failure
    image: apache/rocketmq:5.3.1
    depends_on:
      - mq-namesrv
      - mq-broker
      - mq-proxy
    command:
      - sh
      - -c
      - |
        set -e
        
        # Create Default data bus
        until ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterBusDefault -a +message.type=NORMAL | tee /dev/stderr | grep success; do
        echo "Retrying updateTopic for EBInterBusDefault..."
        sleep 1
        done
        
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterDelayBusDefault -a +message.type=DELAY | tee /dev/stderr | grep success
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterTargetExpDecayBusDefault -a +message.type=NORMAL | tee /dev/stderr | grep success
        ./mqadmin updateTopic -n mq-namesrv:9876 -c DefaultCluster -t EBInterTargetBackoffBusDefault -a +message.type=NORMAL | tee /dev/stderr | grep success

        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g DefaultSource | tee /dev/stderr | grep success
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g DefaultSourceDelay | tee /dev/stderr | grep success
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g DefaultTargetExpDecay -r 176 | tee /dev/stderr | grep success
        ./mqadmin updateSubGroup -n mq-namesrv:9876 -c DefaultCluster -g DefaultTargetBackoff -r 3 | tee /dev/stderr | grep success
